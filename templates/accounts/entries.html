{% extends "base.html" %}
{% block content %}
<section
  class="mx-auto w-full max-w-6xl space-y-8"
  ng-controller="EntriesController as vm"
  ng-init="vm.init('entries-data')"
>
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <p class="text-sm font-semibold uppercase tracking-widest text-blue-600">Cuenta corriente</p>
      <h2 class="text-3xl font-semibold text-slate-900">{{ client.name }}</h2>
      <p class="text-sm text-slate-500">Saldo visualizado según los filtros aplicados.</p>
    </div>
    <a
      href="{% url 'account-entry-add' client.id %}"
      class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-lg transition hover:from-blue-700 hover:to-indigo-700"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m-7-7h14" />
      </svg>
      Nuevo movimiento
    </a>
  </div>

  <div class="grid gap-6 rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200/60 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
    <div class="space-y-3">
      <label class="text-sm font-semibold text-slate-600">Buscar movimiento</label>
      <div class="relative">
        <span class="absolute inset-y-0 left-3 flex items-center text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M18 11a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </span>
        <input
          type="search"
          class="w-full rounded-xl border border-slate-200 bg-slate-50 py-3 pl-11 pr-4 text-sm text-slate-700 shadow-inner transition focus:border-blue-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500/40"
          placeholder="Filtrar por fecha o descripción"
          ng-model="vm.filters.search"
          ng-model-options="{ debounce: 200 }"
          ng-change="vm.applyFilters()"
        />
      </div>
      <p class="text-xs text-slate-500">Podés buscar por palabras clave o fechas (formato AAAA-MM-DD).</p>
    </div>
    <div class="grid gap-4 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 p-5 text-sm text-slate-600">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Entradas listadas</p>
        <p class="text-2xl font-semibold text-slate-900">[[ vm.filteredEntries.length ]]</p>
      </div>
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-400">Total ingresos</p>
          <p class="text-lg font-semibold text-emerald-600">[[ vm.totals.debit | currency:'$':2 ]]</p>
        </div>
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-400">Total egresos</p>
          <p class="text-lg font-semibold text-rose-600">-[[ vm.totals.credit | currency:'$':2 ]]</p>
        </div>
      </div>
    </div>
  </div>

  <form
    method="post"
    action="{% url 'account-entries-invoice' client.id %}"
    class="overflow-hidden rounded-2xl bg-white shadow-lg ring-1 ring-slate-200/60"
    novalidate
  >
    {% csrf_token %}
    <div class="flex flex-wrap items-center justify-between gap-4 border-b border-slate-200/70 bg-slate-50/60 px-6 py-4">
      <div class="space-y-1 text-sm">
        <p class="text-xs uppercase tracking-wide text-slate-400">Facturación rápida</p>
        <p class="font-semibold text-slate-700">
          [[ vm.selection.count ]] movimiento<span ng-if="vm.selection.count !== 1">s</span> seleccionados
        </p>
        <p class="text-xs text-slate-500">
          Total estimado:
          <span class="font-semibold text-slate-600">[[ vm.selection.amount | currency:'$':2 ]]</span>
          <span class="text-amber-600" ng-if="vm.selection.count && vm.selection.amount <= 0">
            (Debe ser mayor que cero)
          </span>
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <label
          for="invoice-type-select"
          class="flex flex-col text-xs font-semibold uppercase tracking-wide text-slate-500"
        >
          <span>Tipo de factura</span>
          <select
            id="invoice-type-select"
            name="invoice_type"
            class="mt-1 rounded-lg border border-slate-300 bg-white px-3 py-2 text-xs font-semibold text-slate-700 shadow-sm transition focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40"
          >
            {% for value, label in invoice_types %}
            <option value="{{ value }}" {% if value == default_invoice_type %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-xl border border-slate-300 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-blue-500 hover:text-blue-600 disabled:cursor-not-allowed disabled:text-slate-400"
          ng-click="vm.toggleSelectAll()"
          ng-disabled="!vm.filteredEntries.length"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
          <span ng-if="vm.selectAll">Deseleccionar visibles</span>
          <span ng-if="!vm.selectAll">Seleccionar visibles</span>
        </button>
        <button
          type="submit"
          class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white shadow-md transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
          ng-disabled="vm.selection.count === 0 || vm.selection.amount <= 0"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m-6-8h6M5 7h.01M5 11h.01M5 15h.01M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          Facturar seleccionados
        </button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
          <tr>
            <th class="px-6 py-3">
              <span class="sr-only">Seleccionar</span>
            </th>
            <th class="px-6 py-3">Fecha</th>
            <th class="px-6 py-3">Descripción</th>
            <th class="px-6 py-3 text-right">Monto</th>
            <th class="px-6 py-3 text-right">Saldo</th>
            <th class="px-6 py-3 text-right">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200" ng-class="{ 'opacity-50': !vm.filteredEntries.length }">
          <tr
            ng-repeat="entry in vm.filteredEntries"
            class="transition hover:bg-slate-50"
            ng-class="{ 'bg-blue-50': entry.selected }"
          >
            <td class="px-6 py-4">
              <input
                type="checkbox"
                name="entries"
                value="[[ entry.id ]]"
                class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                ng-model="entry.selected"
                ng-change="vm.onEntrySelectionChange()"
                aria-label="Seleccionar movimiento"
              />
            </td>
            <td class="px-6 py-4 font-medium text-slate-700">[[ entry.date ]]</td>
            <td class="px-6 py-4 text-slate-600">[[ entry.description ]]</td>
            <td
              class="px-6 py-4 text-right font-semibold"
              ng-class="{ 'text-emerald-600': entry.amount_value >= 0, 'text-rose-600': entry.amount_value < 0 }"
            >
              [[ entry.amount_value | currency:'$':2 ]]
            </td>
            <td class="px-6 py-4 text-right text-slate-600">[[ entry.balance_value | currency:'$':2 ]]</td>
            <td class="px-6 py-4 text-right">
              <button
                type="submit"
                name="single_entry"
                value="[[ entry.id ]]"
                class="inline-flex items-center gap-2 rounded-lg border border-blue-100 bg-blue-50 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-blue-600 transition hover:border-blue-200 hover:bg-blue-100 disabled:cursor-not-allowed disabled:border-slate-200 disabled:bg-slate-100 disabled:text-slate-400"
                ng-disabled="entry.amount_value <= 0"
                ng-attr-title="entry.amount_value <= 0 ? 'El monto debe ser mayor que cero' : null"
              >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-3-3v6m8 5H4a2 2 0 01-2-2V7a2 2 0 012-2h7l2 2h7a2 2 0 012 2v10a2 2 0 01-2 2z" />
                </svg>
                Facturar
              </button>
            </td>
          </tr>
          <tr ng-if="!vm.filteredEntries.length">
            <td colspan="6" class="px-6 py-6 text-center text-slate-500">No hay movimientos que coincidan con el filtro.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </form>

  <noscript>
    <div class="rounded-xl border border-amber-300 bg-amber-50 p-4 text-sm text-amber-700">
      Activá JavaScript para obtener filtros dinámicos. Se muestra la tabla estándar.
      <form
        method="post"
        action="{% url 'account-entries-invoice' client.id %}"
        class="mt-3 space-y-3"
      >
        {% csrf_token %}
        <label for="noscript-invoice-type">Tipo de factura</label>
        <select id="noscript-invoice-type" name="invoice_type">
          {% for value, label in invoice_types %}
          <option value="{{ value }}" {% if value == default_invoice_type %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <table class="w-full text-left">
          <thead>
            <tr>
              <th>Seleccionar</th>
              <th>Fecha</th>
              <th>Descripción</th>
              <th class="text-right">Monto</th>
              <th class="text-right">Saldo</th>
              <th class="text-right">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in entries %}
            <tr>
              <td>
                <input type="checkbox" name="entries" value="{{ entry.id }}" />
              </td>
              <td>{{ entry.date }}</td>
              <td>{{ entry.description }}</td>
              <td class="text-right">{{ entry.amount }}</td>
              <td class="text-right">{{ entry.balance }}</td>
              <td class="text-right">
                <button type="submit" name="single_entry" value="{{ entry.id }}">Facturar</button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6">No hay movimientos registrados.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <button type="submit">Facturar seleccionados</button>
      </form>
    </div>
  </noscript>
</section>
{% endblock %}

{% block extra_scripts %}
<script type="application/json" id="entries-data">
[
{% for entry in entries %}
  {
    "id": {{ entry.id }},
    "date": "{{ entry.date|date:'d/m/Y'|escapejs }}",
    "description": "{{ entry.description|escapejs }}",
    "amount": "{{ entry.amount }}",
    "balance": "{{ entry.balance }}"
  }{% if not forloop.last %},{% endif %}
{% endfor %}
]
</script>
{% endblock %}
